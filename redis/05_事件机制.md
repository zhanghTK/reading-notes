Redis 服务器是一个事件驱动程序，服务器需要处理两类事件：

1. 文件事件：Redis 服务器通过套接字与客户端连接，文件事件是套接字操作抽象
2. 时间事件：给定时间点上服务器的操作

## 文件事件

Reactor 模式实现的网络通信程序

使用 IO 多路复用技术监听多个套接字，根据套接字状态产生对应的文件事件，由文件事件分派器分发给对应的时间处理器。

套接字操作与时间类型关系：

- 当套接字可读时或者有新的可应答套接字出现时，套接字产生 ae.h/AE_READABLE 事件
- 当套接字可写时，套接字产生 AE_WRITABLE 事件

### 完整的客户端与服务器连接事件

1. Redis 正在运行，服务器的监听套接字的 AE_READABLE 事件应该正处于监听状态下，而该事件所对应的处理器为连接应答处理器
2. Redis 客户端向服务器发起连接，监听套接字将产生 AE_READABLE 事件，触发连接应答处理器执行。处理器会对客户端连接请求进行应答，然后创建客户端套接字，以及客户端状态，并将客户端套接字的 AE_READABLE 事件与命令请求处理器进行关联，使得客户端可以向服务器发送命令请求
3. 客户端向服务器发送一个命令请求，客户端套接字将产生 AE_READABLE 事件，引发命令请求处理器执行，处理器读取客户端命令内容，然后传给相关程序执行
4. 执行命令产生相应命令回复，为了将这些命令回复送回客户端，服务器会将客户端套接字的 AE_WRITEABLE 事件与命令回复处理器进行关联。当客户端尝试读取命令回复的时候，客户端套接字将产生 EA_WRITEABLE 事件，触发命令回复处理器执行，当命令回复处理器将命令回复全部写入套接字之后，服务器就会解除客户端套接字的 WE_WRITEABLE 事件与命令回复处理器之间的关联

## 时间事件

一个时间事件的三个主要属性：

1. id：时间事件全局唯一 ID
2. when：毫秒精确的 UNIX 时间戳，记录时间事件到达时间
3. timeProc：时间事件处理器

时间事件分类：

1. 定时事件
2. 周期事件

时间事件类别由时间处理器返回值决定

- 返回 ae.h/AE_NOMORE：定时时间
- 返回非 ae.h/AE_NOMORE：周期时间 

服务器根据时间类型，在时间处理器返回后，更新时间事件的 when 属性

Redis 只使用周期时间，而没有使用定时时间

### 实现

时间事件使用链表形式存放，时间事件执行器运行就是遍历整个链表，查找所有已到达时间事件，并调用相应事件处理器。链表顺序为 ID 升序，与 when 属性大小无关。

### 时间事件应用：serverCron函数

serverCron 主要工作：

- 更新服务器各类统计信息，如：时间，内存，数据库占用等
- 清理数据库中过期键
- 关闭清理链接失效的客户端
- 尝试进行持久化操作
- 如果是主服务器，尝试对从服务器进行定期同步
- 如果是集群模式，对集群进行定期同步和连接测试

Redis 服务器以周期性时间方式运行 serverCron 函数，在服务器运行期间默认每秒运行10次，知道服务器关闭

## 事件的调度与执行

事件的调度和执行由 ae.c/aeProcessEvents 函数负责，伪代码：

```python
def aeProcessEvents():
    // 获得到达时间离当前时间最接近的时间事件
    time_event = aeSearchNearestTimer()
    
    // 计算最接近时间事件距离到达还有多少毫秒
    remaind_ms = time_event.when - unix_ts_now()
    
    // 如果已到达，那么重置距离时间为0
    if remaind_ms < 0:
        remaind_ms = 0
        
    // 根据距离时间创建timeval结构    
    timeval = create_timeval_with_ms(remaind_ms)
    
    // 阻塞并等待文件事件产生，最大阻时间由传入的timeval结构决定
    // 如果距离时间remaind_ms值为0，调用后立即返回，不阻塞
    aeApiPoll(timeval)
    
    // 处理所有已产生的文件事件
    processFileEvents()
    
    // 处理所有已到达的时间事件
    processTimeEvents()
```

1. aeApiPoll 函数的最大阻塞事件由到达时间最近当前时间的时间事件决定
2. 如果处理完一次文件事件后仍没有时间事件到达，将再次等待处理文件事件
3. 所有事件都是同步、有序、原子的执行。服务器不会中途中断或抢占，事件本身需要主动让出执行权
4. 时间事件的实际处理时间通常会比预设的时间稍晚