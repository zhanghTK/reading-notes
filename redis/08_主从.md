## 旧版复制

复制功能分为同步和命令传播两个操作：
- 同步：将从服务器的数据状态更新至主服务当前所处的数据库状态
- 命令传播：主服务的数据库状态被修改，导致主从服务器数据库状态出现不一致时，让主从服务器数据重回一致

### 同步

同步操作通过 SYNC 命令完成，执行步骤：
1. 从服务器向主服务器发送 SYNC 命令
2. 主服务器收到 SYNC 后执行 BGSAVE，生成 RDB 文件，并使用一个缓冲区记录从现在开始执行的所有写命令
3. 当主服务的 BGSAVE 命令执行完毕，主服务器将生成的 RDB 文件发送给从服务器；从服务器接收并加载 RDB 文件，更新数据库状态至主服务器执行 BGSAVE 命令时的数据库状态
4. 主服务器将记录在缓冲区里所有写命令发送给从服务器，从服务器执行这些写命令，将数据库状态更新至主服务数据库当前所处状态

![主从服务器的同步过程.png](https://i.loli.net/2017/07/28/597b1248c5121.png)

### 命令传播

主服务器将自己执行的写命令（造成主从服务器不一致的那条写命令）发送给从服务器执行

## 旧版复制缺陷

从服务器对主服务器复制的两种场景：
1. 初次复制
2. 断线后重复制

![从服务器在断线之后重新复制主服务器的例子.png](https://i.loli.net/2017/07/28/597b143a163c3.png)

缺陷：
1. RDB 是快照文件，断线后重复制会导致全量更新，哪怕只有少量数据差异
2. SYNC 命令的执行会消耗大量资源。主服务器：CPU, 内存, IO；从服务器：载入 RDB 期间阻塞无法处理命令请求；主从之间：网络

## 新版复制功能

Redis 从 2.8 版本开始使用 PSYNC 替代 SYNC 来执行复制时的同步操作。

PSYNC 分为两种同步模式：

- 完整重同步：同于处理初次复制，与 SYNC 执行步骤基本一致

- 部分重同步：处理断线后重复制，主服务器将主从服务器连接断开期间执行的写命令发送给从服务器，从服务器只要接受并执行这些命令，就可以将数据库更新至主服务器当前所处状态

![82279477-f1a6-4fc6-9afe-88205b62215d.png](https://i.loli.net/2017/08/03/59827df32b50e.png)

## 部分重同步实现

### 复制偏移量

主从服务器会分别各自的复制偏移量，用来标记当前发送/接受的总字节数。如果主从的复制偏移量不同说明主从之间数据不一致。
类似与 TCP 的 seq，都是为了保持同步的东东。

### 复制积压缓冲区

复制积压缓冲区是由主服务器维护的一个固定长度先进先出队列，默认大小 1MB

固定长度先进先出队列：当元素大于队列长度时，会丢弃队列头部的元素

复制积压缓冲区作用：备份主服务器发往从服务器的写命令，同时为队列中每个字节记录相应的复制偏移量

当发生断线重连操作：
- 如果复制偏移量之后的数据仍在复制积压缓冲区，那么主服务器对从服务器执行部分重同步操作
- 否则，主服务器将对从服务器执行完整重同步操作

复制积压缓冲区设置：repl-backlog-size 选项，建议大小：重连平均时间 * 写命令的数据速递 * 2

### 服务器运行 ID

无论主从，在启动时自动生成 运行 ID，初次复制时，主会将 ID 发给从。作用：恢复连接之后，从如何确定主是否发生过变更：

- 是：主服务器尝试部分重同步

- 否：主执行完整重同步操作

## PSYNC 命令实现

![PSYNC](http://images0.cnblogs.com/blog2015/754165/201508/072135109876128.png)

## 复制实现

向从服务器发送 SLAVEOF 命令，让从取复制一个主服务器：SLAVEOF <master_ip> <master_port>

1. 设置主服务器的地址和端口
   redisServer 中定义了 char *masterhost; int masterport; 用于记录主服务器的地址和端口。
   SLAVEOF 命令执行后，从服务器保存主服务器的地址和端口，给客户端返回 OK（异步）

2. 建立套接字连接
   从服务器建立到主机的连接，建文件事件处理器
   主服务器接收连接后，创建客户端状态
   此时从服务器是主服务器客户端

3. 从服务器发送 PING 命令
   用于检查连接套接字，检查主服务器是否正常处理命令请求
   ![从服务器发送 PING 流程](http://images0.cnblogs.com/blog2015/754165/201508/072135109876128.png)
   
4. 身份验证
   根据从服务器的 masterauth 选项决定是否进行身份验证
   ![身份验证流程](http://images0.cnblogs.com/blog2015/754165/201508/111612480989940.png)

5. 发送端口信息
   从服务器执行命令 REPLCONF listening-port <port-number>, 向主服务器发送从服务器的监听端口号。
   redisClient 中定义 slave_listening_port 用于保存从服务器端口，可以通过 INFO replication 获得

6. 同步
   从服务器将向主服务器发送 PSYNC 命令，进行完整重同步操作或部分重同步操作。此时主服务器是从服务器客户端（互为客户端）

7. 命令传播
   主服务器一直将自己执行的写命令发送给从服务器

## 心跳检测
从服务器默认会以每秒一次的频率向主服务器发送命令：REPLCONF ACK <replication_offset>，起作用：

### 检测网络连接

主服务器如果超过一秒没有接受到从服务器发来的 REPLCONF ACK 命令，则主服务器知道网络出现问题，可是用 INFO replication 查看相关信息（lag）

### 辅助实现 min-slaves 配置选项

Redis 的 min-slaves-to-write 和 min-slaves-max-log 选项可以防止主服务器在不安全的情况下执行写命令，例：

```shell
# 当服务器数量少于 3 个或 3 个从服务器的延迟都大于等于 10 秒时，主服务器将拒绝执行写命令
min-slaves-to-write 3
min-slaves-max-lag 10
```

### 检测命令丢失

类似于 TCP 的 ACK 作用，当主服务器发现 ACK 的值与主不一致时重传从缺失是数据