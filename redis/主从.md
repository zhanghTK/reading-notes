## 旧版复制

复制功能分为同步和命令传播两个操作：
- 同步：将从服务器的数据状态更新至主服务当前所处的数据库状态
- 命令传播：主服务的数据库状态被修改，导致主从服务器数据库状态出现不一致时，让主从服务器数据重回一致

### 同步

同步操作通过 SYNC 命令完成，执行步骤：
1. 从服务器向主服务器发送 SYNC 命令
2. 主服务器收到 SYNC 后执行 BGSAVE，生成 RDB 文件，并使用一个缓冲区记录从现在开始执行的所有写命令
3. 当主服务的 BGSAVE 命令执行完毕，主服务器将生成的 RDB 文件发送给从服务器；从服务器接收并加载 RDB 文件，更新数据库状态至主服务器执行 BGSAVE 命令时的数据库状态
4. 主服务器将记录在缓冲区里所有写命令发送给从服务器，从服务器执行这些写命令，将数据库状态更新至主服务数据库当前所处状态

![主从服务器的同步过程.png](https://i.loli.net/2017/07/28/597b1248c5121.png)

### 命令传播

主服务器将自己执行的写命令（造成主从服务器不一致的那条写命令）发送给从服务器执行

## 旧版复制缺陷

从服务器对主服务器复制的两种场景：
1. 初次复制
2. 断线后重复制

![从服务器在断线之后重新复制主服务器的例子.png](https://i.loli.net/2017/07/28/597b143a163c3.png)

